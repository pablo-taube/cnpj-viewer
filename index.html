<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Consulta Interna de CNPJs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="./office-building.png">


<style>
:root {
    --app-bg: #F2F2F7;
    /* Adicionado gradiente e propriedades visuais do anterior */
    --app-gradient: radial-gradient(circle at 50% 0, #dbeafe 0%, transparent 75%);
    --card-bg: rgba(255, 255, 255, 0.92);
    --header-bg: rgba(242, 242, 247, 0.85);
    --text-primary: #1C1C1E;
    --text-secondary: #8E8E93;
    --accent-color: #007AFF;
    --separator: rgba(60, 60, 67, 0.18);
    --card-border: rgba(255, 255, 255, 0.9);
    --shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
    /* Recuperadas as cores de disclaimer/warning */
    --warning-bg: rgba(255, 149, 0, 0.1);
    --warning-text: #FF9500;
    --error: #FF3B30;
    --success: #34C759;
}

[data-theme="dark"] {
    --app-bg: #000000;
    --app-gradient: none;
    --card-bg: rgba(28, 28, 30, 0.8);
    --header-bg: rgba(0, 0, 0, 0.8);
    --text-primary: #FFFFFF;
    --text-secondary: #98989D;
    --separator: rgba(84, 84, 88, 0.50);
}

* { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

body {
    margin: 0; 
    font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", sans-serif;
    background: var(--app-bg);
    background-image: var(--app-gradient);
    background-attachment: fixed;
    color: var(--text-primary);
    display: flex; 
    flex-direction: column; 
    min-height: 100vh;
}

header {
    position: sticky; top: 0; z-index: 1000; height: 56px;
    display: grid; grid-template-columns: 100px 1fr 100px; align-items: center;
    padding: 0 16px; background-color: var(--header-bg);
    backdrop-filter: blur(20px) saturate(180%); border-bottom: 0.5px solid var(--separator);
}

main { max-width: 98%; margin: 24px auto; padding: 0 20px; flex: 1; width: 100%; }

/* Disclaimer Ajustado para compatibilidade */
.disclaimer-card {
    background-color: var(--warning-bg); 
    border-left: 4px solid var(--warning-text);
    padding: 16px 20px; 
    border-radius: 12px; 
    margin-bottom: 20px;
}

.disclaimer-card span { 
    display: block; 
    font-size: 11px; 
    font-weight: 700; 
    text-transform: uppercase; 
    color: var(--warning-text); 
    margin-bottom: 4px; 
}

.card {
    background: var(--card-bg); 
    backdrop-filter: blur(40px);
    border: 1px solid var(--card-border); 
    border-radius: 20px;
    box-shadow: var(--shadow); 
    padding: 24px; 
    position: relative; 
    overflow: hidden;
}

header button {
    background: none; border: none; color: var(--accent-color);
    font-size: 15px; cursor: pointer; padding: 8px; border-radius: 8px;
}

header button:disabled { opacity: 0.3; cursor: not-allowed; }

main { max-width: 1550px; margin: 24px auto; padding: 0 20px; flex: 1; width: 100%; }

.disclaimer-card {
    background-color: var(--warning-bg); border-left: 4px solid var(--warning-text);
    padding: 16px 20px; border-radius: 12px; margin-bottom: 20px;
}

.disclaimer-card span { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--warning-text); margin-bottom: 4px; }

.card {
    background: var(--card-bg); backdrop-filter: blur(40px);
    border: 1px solid var(--card-border); border-radius: 20px;
    box-shadow: var(--shadow); padding: 24px; position: relative; overflow: hidden;
}

#status-container { margin-top: 16px; display: none; text-align: center; }
#timer-text { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.progress-bar-bg { width: 100%; height: 4px; background: var(--separator); position: absolute; top: 0; left: 0; }
#progress-bar-fill { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.5s ease; }

textarea {
    width: 100%; height: 100px; border-radius: 14px; border: 1px solid var(--separator);
    padding: 16px; font-size: 15px; background: rgba(128, 128, 128, 0.05);
    color: var(--text-primary); outline: none; resize: none; margin-bottom: 10px;
}

.main-btn {
    margin-top: 16px;
    background: var(--accent-color); color: #fff; border: none;
    padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%;
}

.table-wrapper { overflow-x: auto; margin-top: 24px; }
table { width: 100%; border-collapse: collapse; font-size: 10px; }
th { text-align: left; padding: 10px; color: var(--text-secondary); text-transform: uppercase; border-bottom: 1px solid var(--separator); white-space: nowrap; }
td { padding: 10px; border-bottom: 0.5px solid var(--separator); vertical-align: top; }

.truncate { max-width: 110px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help; }
.ok { color: var(--success); font-weight: 600; }
.bold { font-weight: 600; }

footer {
    padding: 24px; text-align: center; font-size: 12px;
    color: var(--text-secondary); border-top: 0.5px solid var(--separator);
}

table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 11px; 
    white-space: nowrap; 
}

th { 
    background: #f8f8f8;
    text-align: left; padding: 12px 10px; 
    color: var(--text-secondary); 
    text-transform: uppercase; 
    border-bottom: 1px solid var(--separator);
}

td { 
    padding: 12px 10px; 
    border-bottom: 0.5px solid var(--separator); 
    vertical-align: top;
}

.pill {
    display: inline-block; padding: 2px 8px; border-radius: 20px;
    font-size: 9px; font-weight: 700; color: #fff; margin-bottom: 4px;
}

.cnae-col-main { min-width: 250px; white-space: normal; }
.cnae-col-sec { min-width: 350px; white-space: normal; }

.secundario-list {
    max-height: 120px;
    overflow-y: auto;
    font-size: 10px;
}

.secao-header {
    display: block; font-weight: 800; color: var(--accent-color);
    margin-top: 5px; font-size: 9px;
}

.sec-item { display: block; margin: 2px 0; border-left: 2px solid var(--separator); padding-left: 5px; }

footer { 
    padding: 24px; text-align: center; font-size: 12px; 
    color: var(--text-secondary); border-top: 0.5px solid var(--separator);
}
</style>
</head>

<body>

<header>
    <button onclick="document.body.classList.toggle('dark-mode')" style="background:none; border:none; cursor:pointer;">☾</button>
    <h1 style="font-size: 16px; margin: 0;">Consulta Interna de CNPJs</h1>
    <button id="exportarBtn" onclick="exportarExcel()" style="background:none; border:none; color:var(--accent-color); font-weight:600; cursor:pointer;" disabled>Exportar em Excel</button>
</header>

<main>
    <div class="disclaimer-card">
        <span>⚠️ Aviso de Confidencialidade</span>
        <p>- Este site deve ser utilizado apenas internamente no âmbito da UNIDES, não devendo ser compartilhado. <br> - Os dados são de responsabilidade da <a href="https://receitaws.com.br/">ReceitaWS</a> e levam cerca de 21 segundos por item. <br> - A classificação de setores é baseada na lista disponibilizada pelo IBGE..</p>
    </div>
    
    <div class="card">
        <textarea id="listaCNPJs" placeholder="Insira os CNPJs aqui..."></textarea>
        <button id="btnConsultar" class="main-btn" onclick="iniciarFila()">Processar CNPJs</button>
        
        <div id="status-container">
            <div id="timer-text">Tempo restante estimado: <span id="tempo-restante">--:--</span></div>
        </div>

        <div class="table-wrapper">
            <table id="tabela">
                <thead>
                    <tr>
                        <th>CNPJ</th>
                        <th>Nome Empresarial</th>
                        <th>Nome Fantasia</th>
                        <th>Situação</th>
                        <th>CNAE Principal</th>
                        <th>CNAE Secundários</th>
                        <th>Município/UF</th>
                        <th>Sócio Resp.</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Abertura</th>
                        <th>Última Atualiz.</th>
                        <th>Billing</th>
                    </tr>
                </thead>
                <tbody id="resultado"></tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    Desenvolvido por <strong>Pablo Taube</strong> <br>Dados fornecidos por <a href="https://receitaws.com.br/">ReceitaWS</a>
</footer>

<script>
const INTERVALO = 21000;
let fila = [];
let totalInicial = 0;

const SECOES = {
    'A': { n: 'Agricultura e Pecuária', c: '#2E7D32' }, 
    'B': { n: 'Indústria Extrativas', c: '#4E342E' },
    'C': { n: 'Indústria de Transformação', c: '#1565C0' }, 
    'D': { n: 'Eletricidade e Gás', c: '#FF8F00' },
    'E': { n: 'Água e Esgoto', c: '#00838F' }, 
    'F': { n: 'Construção', c: '#37474F' },
    'G': { n: 'Comércio e Reparação Veicular', c: '#C2185B' }, 
    'H': { n: 'Transporte, Armazenagem e Correios', c: '#6A1B9A' },
    'I': { n: 'Alojamento e Alimentação.', c: '#D84315' }, 
    'J': { n: 'Informação e Comunicação', c: '#283593' },
    'K': { n: 'Atividades Financeiras e Seguros', c: '#4527A0' }, 
    'L': { n: 'Atividades Imobiliárias.', c: '#212121' },
    'M': { n: 'Atividades Profissionais, Científicas e Técnicas', c: '#00695C' }, 
    'N': { n: 'Atividades Administrativas', c: '#558B2F' },
    'O': { n: 'Administração Pública', c: '#B71C1C' }, 
    'P': { n: 'Educação', c: '#9E9D24' },
    'Q': { n: 'Saúde e Serviços Sociais', c: '#0277BD' }, 
    'R': { n: 'Artes, Cultura Esporte e Recreação', c: '#FF6F00' },
    'S': { n: 'Outras atividades de Serviços', c: '#424242' }, 
    'T': { n: 'Serviços Domésticos.', c: '#000000' },
    'U': { n: 'Organismos Internacionais.', c: '#3E2723' }
};

function formatarTempo(ms) {
    const totalSegundos = Math.floor(ms / 1000);
    const minutos = Math.floor(totalSegundos / 60);
    const segundos = totalSegundos % 60;
    return `${minutos}:${segundos.toString().padStart(2, '0')}`;
}

function iniciarFila() {
    const text = document.getElementById("listaCNPJs").value;
    fila = text.split("\n").map(c => c.replace(/\D/g,"")).filter(c => c.length === 14);
    
    if (!fila.length) return alert("Nenhum CNPJ válido.");
    
    totalInicial = fila.length;
    document.getElementById("exportarBtn").disabled = true;
    document.getElementById("status-container").style.display = "block";
    document.getElementById("btnConsultar").disabled = true;
    document.getElementById("btnConsultar").style.opacity = "0.5";
    document.getElementById("resultado").innerHTML = "";
    
    atualizarProgresso();
    consultarProximo();
}

function atualizarProgresso() {
    const faltam = fila.length;
    const processados = totalInicial - faltam;
    const porcentagem = (processados / totalInicial) * 100;
    document.getElementById("progress-bar-fill").style.width = `${porcentagem}%`;
    const tempoEstimadoMs = (faltam * INTERVALO);
    document.getElementById("tempo-restante").innerText = faltam > 0 ? formatarTempo(tempoEstimadoMs) : "Concluído!";
}

function consultarProximo() {
    if (!fila.length) {
        document.getElementById("exportarBtn").disabled = false;
        document.getElementById("btnConsultar").disabled = false;
        document.getElementById("btnConsultar").style.opacity = "1";
        document.getElementById("progress-bar-fill").style.width = "100%";
        return;
    }

    const cnpj = fila.shift();
    atualizarProgresso();

    const tr = document.createElement("tr");
    tr.id = `row-${cnpj}`;
    tr.innerHTML = `<td colspan="13" style="color:var(--text-secondary); text-align:center; padding:15px;">Processando ${cnpj}...</td>`;
    document.getElementById("resultado").prepend(tr);

    const cb = "cb_" + Math.random().toString(36).substr(2, 9);
    window[cb] = data => {
        const row = document.getElementById(`row-${cnpj}`);
        if (data.status === "OK") {
            const principal = `${data.atividade_principal[0].code} - ${data.atividade_principal[0].text}`;
            const secundarias = data.atividades_secundarias?.map(a => `${a.code} - ${a.text}`).join(" | ") || "-";
            const socios = data.qsa?.map(s => s.nome).join(", ") || "Não informado";
            
            // Tratamento da data
            const ultimaAtu = data.ultima_atualizacao ? new Date(data.ultima_atualizacao).toLocaleDateString('pt-BR') : "-";
            
            // Tratamento do Billing conforme parâmetros solicitados
            const bFree = data.billing?.free ? "Grátis" : "Paga";
            const bDb = data.billing?.database ? "Base" : "Cache";
            const billingStr = `${bFree} | ${bDb}`;

            row.innerHTML = `
                <td class="bold">${data.cnpj}</td>
                <td>${data.nome}</td>
                <td>${data.fantasia || "-"}</td>
                <td class="ok">${data.situacao}</td>
                <td class="truncate" title="${principal}">${principal}</td>
                <td class="truncate" title="${secundarias}">${secundarias}</td>
                <td>${data.municipio}/${data.uf}</td>
                <td class="truncate" title="${socios}">${socios}</td>
                <td>${data.email || "-"}</td>
                <td>${data.telefone || "-"}</td>
                <td>${data.abertura}</td>
                <td>${ultimaAtu}</td>
                <td>${billingStr}</td>`;
        } else {
            row.innerHTML = `<td colspan="13" style="color:var(--error)">Erro no CNPJ ${cnpj} (Aguardando intervalo)</td>`;
        }
        setTimeout(consultarProximo, INTERVALO);
    };

    const s = document.createElement("script");
    s.src = `https://receitaws.com.br/v1/cnpj/${cnpj}?callback=${cb}`;
    document.body.appendChild(s);
}

function exportarExcel() {
    let csv = "\ufeff";
    document.querySelectorAll("#tabela tr").forEach(row => {
        let cols = [...row.children].map(td => `"${td.innerText.replace(/"/g,'""')}"`);
        csv += cols.join(";") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `relatorio_consulta_${new Date().getTime()}.csv`;
    a.click();
}
</script>

</body>
</html>