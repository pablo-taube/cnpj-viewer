<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Consulta Interna de CNPJ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --app-bg: #F2F2F7;
    --app-gradient: radial-gradient(circle at 50% 0, #dbeafe 0%, transparent 75%);
    --card-bg: rgba(255, 255, 255, 0.92);
    --header-bg: rgba(242, 242, 247, 0.85);
    --text-primary: #1C1C1E;
    --text-secondary: #8E8E93;
    --accent-color: #007AFF;
    --separator: rgba(60, 60, 67, 0.18);
    --card-border: rgba(255, 255, 255, 0.9);
    --shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
    --warning-bg: rgba(255, 149, 0, 0.1);
    --warning-text: #FF9500;
    --error: #FF3B30;
    --success: #34C759;
}

[data-theme="dark"] {
    --app-bg: #000000;
    --app-gradient: none;
    --card-bg: rgba(28, 28, 30, 0.8);
    --header-bg: rgba(0, 0, 0, 0.8);
    --text-primary: #FFFFFF;
    --text-secondary: #98989D;
    --separator: rgba(84, 84, 88, 0.50);
}

* { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", sans-serif;
    background: var(--app-bg);
    background-image: var(--app-gradient);
    background-attachment: fixed;
    color: var(--text-primary);
}

header {
    position: sticky; top: 0; z-index: 1000; height: 56px;
    display: grid; grid-template-columns: 80px 1fr 80px; align-items: center;
    padding: 0 16px; background-color: var(--header-bg);
    backdrop-filter: blur(20px) saturate(180%); border-bottom: 0.5px solid var(--separator);
}

header h1 { grid-column: 2; font-size: 16px; font-weight: 600; margin: 0; text-align: center; }

header button { background: none; border: none; color: var(--accent-color); font-size: 15px; cursor: pointer; padding: 8px; border-radius: 8px; }

main { max-width: 1400px; margin: 24px auto; padding: 0 20px; }

.disclaimer-card {
    background-color: var(--warning-bg); border-left: 4px solid var(--warning-text);
    padding: 16px 20px; border-radius: 12px; margin-bottom: 20px;
}

.disclaimer-card span { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--warning-text); margin-bottom: 4px; }

.card {
    background: var(--card-bg); backdrop-filter: blur(40px);
    border: 1px solid var(--card-border); border-radius: 20px;
    box-shadow: var(--shadow); padding: 24px; position: relative; overflow: hidden;
}

/* Timer e Progresso */
#status-container { margin-top: 16px; display: none; text-align: center; }
#timer-text { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.progress-bar-bg { width: 100%; height: 4px; background: var(--separator); position: absolute; top: 0; left: 0; }
#progress-bar-fill { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.5s ease; }

textarea {
    width: 100%; height: 100px; border-radius: 14px; border: 1px solid var(--separator);
    padding: 16px; font-size: 15px; background: rgba(128, 128, 128, 0.05);
    color: var(--text-primary); outline: none; resize: none;
}

.main-btn {
    margin-top: 16px; background: var(--accent-color); color: #fff;
    border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%;
}

.table-wrapper { overflow-x: auto; margin-top: 24px; }
table { width: 100%; border-collapse: collapse; font-size: 11px; }
th { text-align: left; padding: 10px; color: var(--text-secondary); text-transform: uppercase; border-bottom: 1px solid var(--separator); white-space: nowrap; }
td { padding: 10px; border-bottom: 0.5px solid var(--separator); vertical-align: top; }

.truncate { max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: help; }
.ok { color: var(--success); font-weight: 600; }
.bold { font-weight: 600; }

footer {
    padding: 32px 20px;
    text-align: center;
    border-top: 0.5px solid var(--separator);
    font-size: 13px;
    color: var(--text-secondary);
    background-color: var(--header-bg);
}

footer strong { color: var(--text-primary); font-weight: 500; }
</style>
</head>

<body>

<header>
    <div class="header-left"><button onclick="toggleTheme()">☾</button></div>
    <h1>Consulta Interna de CNPJ</h1>
    <div class="header-actions"><button id="exportarBtn" onclick="exportarExcel()" style="display:none;">Exportar</button></div>
</header>

<main>
    <div class="disclaimer-card">
        <span>⚠️ Aviso de Confidencialidade</span>
        <p>Este site deve ser utilizado apenas internamento no âmbito da UNIDES, não devendo ser compartilhado. <br> Os dados são de responsabilidade da <a href="https://receitaws.com.br/">ReceitaWS</a> e levam cerca de 21 segundos por item.</p>
    </div>

    <div class="card">
        <div class="progress-bar-bg"><div id="progress-bar-fill"></div></div>
        <textarea id="listaCNPJs" placeholder="Insira os CNPJs (um por linha)..."></textarea>
        <button id="btnConsultar" class="main-btn" onclick="iniciarFila()">Consultar em Lote</button>
        
        <div id="status-container">
            <div id="timer-text">Tempo restante estimado: <span id="tempo-restante">--:--</span></div>
        </div>

        <div class="table-wrapper">
            <table id="tabela">
                <thead>
                    <tr>
                        <th>CNPJ</th>
                        <th>Nome Empresarial</th>
                        <th>Nome Fantasia</th>
                        <th>Situação</th>
                        <th>CNAE Principal</th>
                        <th>CNAE Secundários</th>
                        <th>Município/UF</th>
                        <th>Sócio Responsável</th>
                        <th>Contatos</th>
                        <th>Abertura</th>
                    </tr>
                </thead>
                <tbody id="resultado"></tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    Desenvolvido por <strong>Pablo Taube</strong>. <br> Dados fornecidos por <a href="https://receitaws.com.br/">ReceitaWS</a>.
</footer>

<script>
const INTERVALO = 21000;
let fila = [];
let totalInicial = 0;

function toggleTheme() {
    const body = document.body;
    body.getAttribute('data-theme') === 'dark' ? body.removeAttribute('data-theme') : body.setAttribute('data-theme', 'dark');
}

function formatarTempo(ms) {
    const totalSegundos = Math.floor(ms / 1000);
    const minutos = Math.floor(totalSegundos / 60);
    const segundos = totalSegundos % 60;
    return `${minutos}:${segundos.toString().padStart(2, '0')}`;
}

function iniciarFila() {
    const text = document.getElementById("listaCNPJs").value;
    fila = text.split("\n").map(c => c.replace(/\D/g,"")).filter(c => c.length === 14);
    
    if (!fila.length) return alert("Nenhum CNPJ válido.");
    
    totalInicial = fila.length;
    document.getElementById("exportarBtn").style.display = "none";
    document.getElementById("status-container").style.display = "block";
    document.getElementById("btnConsultar").disabled = true;
    document.getElementById("btnConsultar").style.opacity = "0.5";
    document.getElementById("resultado").innerHTML = "";
    
    atualizarProgresso();
    consultarProximo();
}

function atualizarProgresso() {
    const faltam = fila.length;
    const processados = totalInicial - faltam;
    const porcentagem = (processados / totalInicial) * 100;
    document.getElementById("progress-bar-fill").style.width = `${porcentagem}%`;
    const tempoEstimadoMs = faltam * INTERVALO;
    document.getElementById("tempo-restante").innerText = faltam > 0 ? formatarTempo(tempoEstimadoMs) : "Concluído!";
}

function consultarProximo() {
    if (!fila.length) {
        document.getElementById("exportarBtn").style.display = "block";
        document.getElementById("btnConsultar").disabled = false;
        document.getElementById("btnConsultar").style.opacity = "1";
        return;
    }

    const cnpj = fila.shift();
    atualizarProgresso();

    const tr = document.createElement("tr");
    tr.id = `row-${cnpj}`;
    tr.innerHTML = `<td colspan="10" style="color:var(--text-secondary); text-align:center; padding:15px;">Aguardando retorno para ${cnpj}...</td>`;
    document.getElementById("resultado").prepend(tr);

    const cb = "cb_" + Math.random().toString(36).substr(2, 9);
    window[cb] = data => {
        const row = document.getElementById(`row-${cnpj}`);
        if (data.status === "OK") {
            const principal = `${data.atividade_principal[0].code} - ${data.atividade_principal[0].text}`;
            const secundarias = data.atividades_secundarias?.map(a => `${a.code} - ${a.text}`).join(" | ") || "-";
            const socios = data.qsa?.map(s => s.nome).join(", ") || "Não informado";
            const contato = `${data.email || ""} ${data.telefone || ""}`.trim() || "-";

            row.innerHTML = `
                <td class="bold">${data.cnpj}</td>
                <td>${data.nome}</td>
                <td>${data.fantasia || "-"}</td>
                <td class="ok">${data.situacao}</td>
                <td class="truncate" title="${principal}">${principal}</td>
                <td class="truncate" title="${secundarias}">${secundarias}</td>
                <td>${data.municipio}/${data.uf}</td>
                <td class="truncate" title="${socios}">${socios}</td>
                <td>${contato}</td>
                <td>${data.abertura}</td>`;
        } else {
            row.innerHTML = `<td colspan="10" style="color:var(--error)">Falha na consulta do CNPJ ${cnpj}</td>`;
        }
        setTimeout(consultarProximo, INTERVALO);
    };

    const s = document.createElement("script");
    s.src = `https://receitaws.com.br/v1/cnpj/${cnpj}?callback=${cb}`;
    document.body.appendChild(s);
}

function exportarExcel() {
    let csv = "\ufeff";
    document.querySelectorAll("#tabela tr").forEach(row => {
        let cols = [...row.children].map(td => `"${td.innerText.replace(/"/g,'""')}"`);
        csv += cols.join(";") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `pnce_export_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
    a.click();
}
</script>

</body>
</html>